# Googleカレンダー(iCal) → Mattermost 通知システム 要件定義

## 1. システム概要
- 公開されたGoogleカレンダーのiCal URLから予定を取得し、開始予定時刻が近づいているイベントを自動検出する。
- GitHub Actions上で定期実行し、Mattermostの指定チャンネルへIncoming Webhook経由で通知する。
- 運用者がカスタマイズしやすいシンプルな実装とし、Secretsに認証情報やWebhook URLを保持して安全に運用する。

## 2. 利用サービス・インフラ
- **実行基盤:** GitHub Actions（スケジュールトリガー／手動トリガー）
- **カレンダー:** Googleカレンダー iCal 公開URL
  - サンプル: `https://calendar.google.com/calendar/ical/fd8117b2a22e74a0b4ed513834f059e11ff171b8b787013ba77e8548cbf51033%40group.calendar.google.com/public/basic.ics`
- **通知先:** Mattermost Incoming Webhook（チャンネルはWebhook設定側で固定）

## 3. 前提・制約
- iCal URLは公開リンクを利用するため、追加の認証は不要。
- GitHub Actionsはインターネットアクセス可能な環境で動作する。
- SecretsにWebhook URLなどの機密情報を保持する（リポジトリや組織のSecrets）。
- タイムゾーンは原則UTCで処理し、通知メッセージでJSTなどローカル時刻も併記できるようにする。

## 4. 機能要件
1. **予定取得**
   - iCal URLから直近のイベントを取得する。
   - 取得失敗時はリトライまたはエラー通知（ログ出力・GitHub Actionsの失敗ステータス）。
2. **検知条件**
   - 現在時刻から一定時間以内（例: 30/60/120分など設定値）の開始予定を検出する。
   - 終了したイベントは除外。
   - 1つのイベントが複数回通知されないよう、通知済みのイベントIDと通知時刻をロックファイルまたはキャッシュ（Artifacts/Issueコメント等）で保持することを検討。
3. **通知内容**
   - イベントタイトル、開始・終了時刻（UTCとJSTなどのローカル併記）、場所/説明（存在する場合）、カレンダー名（任意）を含める。
   - 複数のイベントが検知された場合はまとめて1メッセージに箇条書きで通知する。
   - 通知フォーマットはMarkdownベースで、Mattermostでの可読性を考慮する。
4. **スケジュール実行**
   - GitHub Actionsの`cron`で5〜15分間隔の実行を想定。
   - 手動実行（workflow_dispatch）にも対応し、デバッグ・緊急通知を可能にする。
5. **設定項目**
   - `ICAL_URL`（必須）: 取得対象のカレンダーURL。
   - `NOTICE_WINDOW_MINUTES`（必須）: 何分以内に開始する予定を通知するか。
   - `MATTERMOST_WEBHOOK_URL`（必須）: 送信先Webhook。
   - `TIMEZONE`（任意）: 通知表示用のタイムゾーン（例: Asia/Tokyo）。
   - `MAX_EVENTS`（任意）: 1回の通知で扱う最大件数。
6. **重複防止・状態管理**
   - 通知済みイベントを記録する手段を持つ（例: GitHub Actionsのキャッシュ、リポジトリArtifacts、専用ブランチへのJSONコミットなど）。
   - 記録の持続期間やクリーニング手順を定義する。
7. **エラーハンドリング**
   - 取得・解析・送信で例外が起きた場合はジョブを失敗させ、ログに原因を残す。
   - Mattermost側でエラーが返った場合もリトライまたは失敗扱いとする。

## 5. 非機能要件
- **信頼性:** 取得・通知処理は例外を握りつぶさず、失敗時はGitHub Actionsのステータスで検知できる。
- **セキュリティ:** Webhook URLなど機密情報はGitHub Secretsに保存し、ログに出力しない。
- **保守性:** 設定値を環境変数で外部化し、コード/ワークフローを少ないファイルで分かりやすく構成する。
- **可観測性:** 重要なステップ（取得件数、検知件数、送信結果）をログ出力する。

## 6. 受け入れ基準（テスト観点）
- 指定した時間窓内のイベントのみが通知されること。
- 通知フォーマットに必要な項目（タイトル、開始・終了、タイムゾーン、URL等）が含まれていること。
- 同一イベントが短時間に重複通知されないこと。
- iCal取得失敗時にジョブが失敗する、または明示的なエラーログが残ること。
- SecretsにWebhook URLを保存し、コードやログに平文で出力されていないこと。

## 7. 今後の拡張案
- 複数カレンダー対応（複数iCal URLから統合取得）。
- 参加者のレスポンスステータスに応じたフィルタリング。
- Mattermostスラッシュコマンドからのオンデマンド通知トリガー。
- 通知テンプレートの切り替え（短縮版/詳細版）。
- Slack互換Webhookへの送信やメール通知などのマルチチャネル対応。
